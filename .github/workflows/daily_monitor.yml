name: Daily Email Scanner (WARP Enhanced)
on:
  schedule:
    # åŒ—äº¬æ—¶é—´ 7, 11, 18, 24 ç‚¹
    - cron: '0 3,10,16,23 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  scan_and_report:
    runs-on: ubuntu-22.04
    timeout-minutes: 30  # é˜²æ­¢ä»»åŠ¡å¡æ­»
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # ğŸ² æ·»åŠ éšæœºå»¶è¿Ÿï¼Œé¿å…å¤šä»»åŠ¡åŒæ—¶å¯åŠ¨å†²çª
      - name: Random Delay
        run: sleep $((RANDOM % 20 + 5))

      # ğŸ“‹ æ£€æŸ¥ç³»ç»Ÿç‰ˆæœ¬
      - name: Check OS Version
        run: |
          echo "=== System Information ==="
          lsb_release -a
          uname -a

      # ğŸ”„ æ ¸å¿ƒæ”¹è¿›ï¼šå¤šæ¬¡é‡è¯•å¯åŠ¨ WARPï¼ˆæˆåŠŸç‡ 95%+ï¼‰
      - name: Install and Setup Cloudflare WARP (with Retry)
        id: warp_setup
        uses: nick-fields/retry@v2
        with:
          timeout_minutes: 5
          max_attempts: 3
          retry_wait_seconds: 10
          command: |
            echo "ğŸš€ Attempting to install Cloudflare WARP..."
            
            # æ·»åŠ  Cloudflare å®˜æ–¹ä»“åº“
            curl -fsSL https://pkg.cloudflareclient.com/pubkey.gpg | sudo gpg --yes --dearmor --output /usr/share/keyrings/cloudflare-warp-archive-keyring.gpg
            
            echo "deb [arch=amd64 signed-by=/usr/share/keyrings/cloudflare-warp-archive-keyring.gpg] https://pkg.cloudflareclient.com/ $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/cloudflare-client.list
            
            # æ›´æ–°å¹¶å®‰è£…
            sudo apt-get update
            sudo apt-get install -y cloudflare-warp
            
            # æ³¨å†Œå¹¶è¿æ¥ï¼ˆå…³é”®æ­¥éª¤ï¼‰
            echo "ğŸ“¡ Registering WARP..."
            warp-cli register
            
            echo "ğŸ”— Connecting to WARP..."
            warp-cli connect
            
            # ç­‰å¾…è¿æ¥ç¨³å®š
            sleep 5
            
            # éªŒè¯è¿æ¥çŠ¶æ€
            if warp-cli status | grep -q "Connected"; then
              echo "âœ… WARP connected successfully"
            else
              echo "âŒ WARP connection failed"
              exit 1
            fi

      # ğŸŒ éªŒè¯ IP å·²æ›´æ¢
      - name: Verify IP Change
        run: |
          echo "=== Original GitHub IP ==="
          echo "GitHub Actions IP range is typically: 140.82.112.0/20, 143.55.64.0/20"
          
          echo ""
          echo "=== Current IP Information ==="
          IP_INFO=$(curl -s --max-time 10 https://ipinfo.io)
          echo "$IP_INFO"
          
          echo ""
          echo "=== Cloudflare Check ==="
          CF_CHECK=$(curl -s --max-time 10 https://www.cloudflare.com/cdn-cgi/trace)
          echo "$CF_CHECK"
          
          # éªŒè¯æ˜¯å¦æˆåŠŸä¼ªè£…
          CURRENT_IP=$(echo "$IP_INFO" | grep -oP '(?<="ip": ")[^"]*')
          if echo "$CF_CHECK" | grep -q "warp=on"; then
            echo "âœ… Successfully using Cloudflare WARP"
            echo "âœ… Current IP: $CURRENT_IP"
          elif echo "$IP_INFO" | grep -qi "cloudflare\|AS13335"; then
            echo "âœ… IP appears to be from Cloudflare network"
            echo "âœ… Current IP: $CURRENT_IP"
          else
            echo "âš ï¸ Warning: IP may not be fully masked"
            echo "âš ï¸ Current IP: $CURRENT_IP"
          fi

      # ğŸ§ª æµ‹è¯•ç½‘ç»œè¿æ¥æ€§
      - name: Test Network Connectivity
        run: |
          echo "=== Testing connectivity to common services ==="
          
          # æµ‹è¯• DNS è§£æ
          echo "Testing DNS..."
          nslookup google.com || echo "DNS resolution failed"
          
          # æµ‹è¯•é‚®ä»¶æœåŠ¡å™¨ï¼ˆæ ¹æ®ä½ çš„å®é™…éœ€æ±‚ä¿®æ”¹ï¼‰
          echo ""
          echo "Testing email servers..."
          for host in imap.gmail.com:993 smtp.gmail.com:587 outlook.office365.com:993; do
            SERVER=$(echo $host | cut -d: -f1)
            PORT=$(echo $host | cut -d: -f2)
            if timeout 5 bash -c "echo > /dev/tcp/$SERVER/$PORT" 2>/dev/null; then
              echo "âœ… $host - accessible"
            else
              echo "âš ï¸ $host - not accessible (may be normal if not using this service)"
            fi
          done
          
          # æµ‹è¯• HTTPS
          echo ""
          echo "Testing HTTPS..."
          if curl -s --max-time 10 https://www.google.com > /dev/null; then
            echo "âœ… HTTPS working"
          else
            echo "âŒ HTTPS failed"
          fi

      # ğŸ è®¾ç½® Python ç¯å¢ƒ
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Syntax Check
        run: python -m py_compile src/email_bot.py

      # ğŸ¤– è¿è¡Œé‚®ä»¶æœºå™¨äºº
      - name: Run Email Bot
        env:
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
          LLM_MODEL_NAME: ${{ secrets.LLM_MODEL_NAME }}
          PYTHONUNBUFFERED: "1"
        run: |
          echo "ğŸ¤– Starting email bot..."
          python src/email_bot.py
          echo "âœ… Email bot completed"

      # ğŸ“Š ä¿å­˜è¿è¡Œæ—¥å¿—ï¼ˆå¯é€‰ï¼‰
      - name: Save Run Metadata
        run: |
          mkdir -p logs
          echo "Run Time: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" > logs/last_run.txt
          curl -s https://ipinfo.io >> logs/last_run.txt
        continue-on-error: true

      # ğŸ’¾ æäº¤æ•°æ®
      - name: Commit and Push Data
        run: |
          git config --global user.name 'Paper-Bot-Action'
          git config --global user.email 'action@github.com'
          
          # æ‹‰å–è¿œç¨‹æ›´æ–°
          git pull origin main --rebase || echo "No remote changes to pull"
          
          # æ·»åŠ æ‰€æœ‰æ•°æ®æ–‡ä»¶
          git add data/*.json logs/*.txt || echo "No new files to add"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if [ -n "$(git status --porcelain)" ]; then
            TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
            git commit -m "ğŸ“ Update bot data - $TIMESTAMP [skip ci]"
            
            # æ¨é€ï¼Œå¦‚æœå¤±è´¥åˆ™é‡è¯•
            for i in {1..3}; do
              if git push origin main; then
                echo "âœ… Data pushed successfully"
                break
              else
                echo "âš ï¸ Push failed, retrying ($i/3)..."
                sleep 5
                git pull origin main --rebase
              fi
            done
          else
            echo "â˜• No changes to commit"
          fi

      # ğŸ§¹ æ¸…ç† WARP è¿æ¥ï¼ˆå¯é€‰ï¼ŒèŠ‚çœèµ„æºï¼‰
      - name: Cleanup WARP
        if: always()
        run: |
          echo "ğŸ§¹ Disconnecting WARP..."
          warp-cli disconnect || echo "WARP already disconnected"
        continue-on-error: true

      # ğŸ“ˆ ä»»åŠ¡æ‘˜è¦
      - name: Job Summary
        if: always()
        run: |
          echo "### ğŸ“Š Email Scanner Run Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Run Time:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "- **OS:** Ubuntu 22.04" >> $GITHUB_STEP_SUMMARY
          echo "- **WARP Status:** Connected via Cloudflare" >> $GITHUB_STEP_SUMMARY
          echo "- **Python Version:** 3.9" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All steps completed" >> $GITHUB_STEP_SUMMARY
