name: Daily Email Scanner

on:
  schedule:
    # 02:00 UTC = 10:00 AM Beijing Time
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  scan_and_report:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          # ğŸŸ¢ å¼€å¯ç¼“å­˜ï¼Œæå¤§åŠ å¿«åç»­è¿è¡Œé€Ÿåº¦
          cache: 'pip'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run Email Bot
        env:
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
          PYTHONUNBUFFERED: "1"
          LLM_MODEL_NAME: ${{ secrets.LLM_MODEL_NAME }}
        run: python src/email_bot.py

      #å‚¨å­˜å†å²è®°å½•logs
      - name: Commit and Push Data
        run: |
          git config --global user.name 'Paper-Bot-Action'
          git config --global user.email 'action@github.com'
          
          # ğŸŸ¢ å…³é”®ä¿®æ”¹ï¼šæ·»åŠ  data ç›®å½•ä¸‹æ‰€æœ‰çš„ json æ–‡ä»¶
          # è¿™æ · queue_pending.json å’Œ history*.json éƒ½ä¼šè¢«ä¿å­˜
          git add data/*.json || echo "No data files found"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŠ¨ï¼Œæœ‰å˜åŠ¨æ‰æäº¤ï¼Œé˜²æ­¢æŠ¥é”™
          if [ -n "$(git status --porcelain)" ]; then
            git commit -m "ğŸ“ Update bot history & queue [skip ci]"
            git push
            echo "âœ… Data pushed to repository."
          else
            echo "â˜• No changes to commit."
          fi
