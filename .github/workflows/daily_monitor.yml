name: Daily Email Scanner

on:
  schedule:
    # åŒ—äº¬æ—¶é—´ (UTC+8) -> UTC æ—¶é—´
    # 07:00 BJT = 23:00 UTC (å‰ä¸€å¤©)
    # 11:00 BJT = 03:00 UTC
    # 18:00 BJT = 10:00 UTC
    # 24:00 BJT = 16:00 UTC
    - cron: '0 3,10,16,23 * * *'
  
  # å…è®¸æ‰‹åŠ¨ç‚¹å‡»æŒ‰é’®è§¦å‘
  workflow_dispatch:

permissions:
  contents: write

jobs:
  scan_and_report:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          cache: 'pip' # ğŸŸ¢ å¼€å¯ç¼“å­˜åŠ é€Ÿ

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # ğŸŸ¢ è¿è¡Œå‰å…ˆæ£€æŸ¥è¯­æ³•ï¼Œé˜²æ­¢ä½çº§é”™è¯¯æµªè´¹æ—¶é—´
      - name: Syntax Check
        run: python -m py_compile src/email_bot.py

      - name: Run Email Bot
        env:
          # åŠ¡å¿…åœ¨ä»“åº“ Settings -> Secrets ä¸­é…ç½®è¿™äº›å˜é‡
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
          LLM_MODEL_NAME: ${{ secrets.LLM_MODEL_NAME }}
          # å¼ºåˆ¶ Python å®æ—¶è¾“å‡ºæ—¥å¿—ï¼Œä¸è¦ç¼“å­˜
          PYTHONUNBUFFERED: "1"
        run: python src/email_bot.py

      # ğŸŸ¢ è‡ªåŠ¨ä¿å­˜æ•°æ®åº“å˜åŠ¨ (æ ¸å¿ƒåŠŸèƒ½)
      - name: Commit and Push Data
        run: |
          # é…ç½® Git èº«ä»½
          git config --global user.name 'Paper-Bot-Action'
          git config --global user.email 'action@github.com'
          
          # æ‹‰å–æœ€æ–°ä»£ç é˜²æ­¢å†²çª
          git pull origin main || echo "No remote changes"
          
          # æ·»åŠ æ•°æ®æ–‡ä»¶
          git add data/*.json || echo "No data files found"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŠ¨
          if [ -n "$(git status --porcelain)" ]; then
            git commit -m "ğŸ“ Update bot history & queue [skip ci]"
            git push
            echo "âœ… Data pushed to repository."
          else
            echo "â˜• No changes to commit."
          fi
